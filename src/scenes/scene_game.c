#include <scenes/game.h>
#include <app/base.h>
#include <app/sdl2.h>
#include <ren/base.h>
#include <go/base.h>
#include <go/go.h>
#include <minstd.h>
#define base ((Scene*)this)

// TODO: seperate file to parse, seperate func to transform pos

void scene_game_on_init(SceneGame* this) {
	this->def_bg_col.a = this->def_gr_col.a = 255.0f;
	this->obj = f_alloc(sizeof(GObject*) * 1024 * 4);
	MEMSET(this->obj, 0, sizeof(GObject*) * 1024 * 4);
	char lv_str[] = "kS1,40,kS2,62,kS3,255,kS4,0,kS5,19,kS6,200,kA1,0;1,29,2,135,3,135,7,158,8,3,9,255,10,10.0;1,30,2,135,3,165,7,96,8,0,9,185,10,10.0;1,8,2,525,3,15;1,39,2,975,3,6;1,8,2,1005,3,15;1,8,2,1485,3,15;1,8,2,1455,3,15;1,1,2,1515,3,15;1,9,2,1545,3,2;1,9,2,1575,3,2;1,20,2,1575,3,13;1,16,2,1515,3,44;1,1,2,1635,3,45;1,9,2,1605,3,2;1,9,2,1635,3,2;1,9,2,1665,3,2;1,7,2,1635,3,15;1,9,2,1695,3,2;1,19,2,1695,3,19;1,16,2,1635,3,74;1,9,2,1725,3,2;1,1,2,1755,3,75;1,7,2,1755,3,45;1,7,2,1755,3,15;1,16,2,1755,3,104;1,8,2,2385,3,15;1,8,2,2415,3,15;1,3,2,2595,3,15;1,2,2,2625,3,15;1,2,2,2655,3,15;1,2,2,2685,3,15;1,2,2,2715,3,15;1,2,2,2745,3,15;1,2,2,2775,3,15;1,3,2,2805,3,15,4,1;1,9,2,2835,3,2;1,9,2,2865,3,2;1,9,2,2895,3,2;1,20,2,2865,3,13;1,3,2,2925,3,15;1,2,2,2955,3,15;1,2,2,2985,3,15;1,2,2,3015,3,15;1,2,2,3045,3,15;1,2,2,3075,3,15;1,8,2,3075,3,45;1,2,2,3105,3,15;1,2,2,3135,3,15;1,2,2,3165,3,15;1,2,2,3195,3,15;1,3,2,3225,3,15,4,1;1,9,2,3255,3,2;1,9,2,3285,3,2;1,21,2,3285,3,7;1,9,2,3315,3,2;1,3,2,3345,3,45;1,2,2,3345,3,15,6,-90;1,2,2,3375,3,45;1,5,2,3375,3,15;1,2,2,3405,3,45;1,2,2,3435,3,45;1,2,2,3465,3,45;1,2,2,3495,3,45;1,5,2,3405,3,15;1,5,2,3435,3,15;1,5,2,3465,3,15;1,5,2,3495,3,15;1,2,2,3525,3,45;1,5,2,3525,3,15;1,2,2,3585,3,45;1,2,2,3555,3,45;1,5,2,3585,3,15;1,5,2,3555,3,15;1,8,2,3555,3,75;1,2,2,3645,3,45;1,2,2,3675,3,45;1,2,2,3615,3,45;1,5,2,3615,3,15;1,5,2,3645,3,15;1,5,2,3675,3,15;1,27,2,3615,3,165;1,9,2,3765,3,2;1,9,2,3795,3,2;1,3,2,3735,3,45,4,1;1,2,2,3735,3,15,6,90;1,5,2,3705,3,15;1,2,2,3705,3,45;1,9,2,3825,3,2;1,9,2,3885,3,2;1,9,2,3855,3,2;1,40,2,3855,3,83;1,17,2,3855,3,71,5,1;1,18,2,3855,3,19;1,9,2,3915,3,2;1,9,2,3945,3,2;1,9,2,3975,3,2;1,40,2,3975,3,113;1,17,2,3975,3,101,5,1;1,9,2,4005,3,2;1,9,2,4035,3,2;1,9,2,4065,3,2;1,9,2,4095,3,2;1,21,2,4035,3,7;1,40,2,4095,3,143;1,17,2,4095,3,131,5,1;1,9,2,4125,3,2;1,9,2,4155,3,2;1,9,2,4185,3,2;1,9,2,4215,3,2;1,9,2,4245,3,2;1,9,2,4275,3,2;1,19,2,4209,3,19;1,40,2,4215,3,173;1,17,2,4215,3,161,5,1;1,9,2,4305,3,2;1,9,2,4335,3,2;1,9,2,4365,3,2;1,9,2,4395,3,2;1,40,2,4335,3,203;1,17,2,4335,3,191,5,1;1,18,2,4305,3,19;1,9,2,4425,3,2;1,9,2,4455,3,2;1,9,2,4485,3,2;1,20,2,4455,3,13;1,6,2,4455,3,165,6,-90;1,7,2,4485,3,165,6,-90;1,2,2,4515,3,135,6,-90;1,2,2,4515,3,105,6,-90;1,2,2,4515,3,75,6,-90;1,2,2,4515,3,45,6,-90;1,2,2,4515,3,15,6,-90;1,2,2,4575,3,165;1,5,2,4545,3,135;1,5,2,4575,3,135;1,5,2,4575,3,15;1,5,2,4545,3,15;1,5,2,4545,3,45;1,5,2,4545,3,75;1,5,2,4575,3,105;1,5,2,4545,3,105;1,5,2,4575,3,75;1,5,2,4575,3,45;1,2,2,4545,3,165;1,2,2,4515,3,165;1,2,2,4605,3,165;1,2,2,4635,3,165;1,2,2,4665,3,165;1,2,2,4695,3,165;1,5,2,4605,3,135;1,5,2,4635,3,135;1,5,2,4665,3,135;1,5,2,4695,3,135;1,5,2,4695,3,15;1,5,2,4665,3,15;1,5,2,4635,3,15;1,5,2,4605,3,15;1,5,2,4605,3,75;1,5,2,4605,3,105;1,5,2,4605,3,45;1,5,2,4635,3,45;1,5,2,4665,3,45;1,5,2,4695,3,45;1,5,2,4695,3,105;1,5,2,4665,3,105;1,5,2,4635,3,105;1,5,2,4635,3,75;1,5,2,4665,3,75;1,5,2,4695,3,75;1,8,2,4635,3,195;1,40,2,4695,3,233;1,8,2,4665,3,195;1,8,2,4695,3,195;1,40,2,4665,3,233;1,2,2,4725,3,165;1,2,2,4755,3,165;1,2,2,4785,3,165;1,5,2,4725,3,135;1,5,2,4755,3,135;1,5,2,4785,3,135;1,5,2,4785,3,15;1,5,2,4755,3,15;1,5,2,4725,3,15;1,5,2,4725,3,45;1,5,2,4755,3,45;1,5,2,4785,3,45;1,5,2,4785,3,75;1,5,2,4785,3,105;1,5,2,4755,3,105;1,5,2,4725,3,105;1,5,2,4725,3,75;1,5,2,4755,3,75;1,8,2,4725,3,195;1,2,2,4815,3,165;1,5,2,4815,3,135;1,5,2,4815,3,105;1,5,2,4815,3,75;1,5,2,4815,3,45;1,5,2,4815,3,15;1,8,2,4875,3,195;1,2,2,4845,3,165;1,2,2,4875,3,165;1,5,2,4845,3,15;1,5,2,4875,3,15;1,5,2,4875,3,135;1,5,2,4845,3,135;1,5,2,4845,3,105;1,5,2,4845,3,75;1,5,2,4875,3,75;1,5,2,4875,3,45;1,5,2,4875,3,105;1,5,2,4845,3,45;1,40,2,4905,3,233;1,40,2,4935,3,233;1,8,2,4905,3,195;1,8,2,4935,3,195;1,8,2,4965,3,195;1,2,2,4905,3,165;1,2,2,4935,3,165;1,2,2,4965,3,165;1,2,2,4995,3,165;1,5,2,4905,3,15;1,5,2,4935,3,15;1,5,2,4965,3,15;1,5,2,4995,3,15;1,5,2,4995,3,105;1,5,2,4965,3,105;1,5,2,4965,3,135;1,5,2,4935,3,135;1,5,2,4905,3,135;1,5,2,4905,3,45;1,5,2,4935,3,45;1,5,2,4965,3,45;1,5,2,4995,3,45;1,5,2,4995,3,135;1,5,2,4995,3,75;1,5,2,4965,3,75;1,5,2,4935,3,75;1,5,2,4905,3,75;1,5,2,4905,3,105;1,5,2,4935,3,105;1,2,2,5025,3,165;1,2,2,5055,3,165;1,5,2,5025,3,15;1,5,2,5055,3,15;1,5,2,5085,3,15;1,5,2,5085,3,45;1,5,2,5085,3,75;1,5,2,5085,3,105;1,5,2,5055,3,135;1,5,2,5025,3,135;1,5,2,5025,3,105;1,5,2,5025,3,45;1,5,2,5055,3,45;1,5,2,5055,3,75;1,5,2,5055,3,105;1,5,2,5025,3,75;1,3,2,5085,3,165,4,1;1,4,2,5085,3,135,4,1;1,5,2,5175,3,15;1,5,2,5145,3,15;1,5,2,5115,3,15;1,5,2,5115,3,45;1,5,2,5115,3,75;1,5,2,5115,3,105;1,5,2,5175,3,45;1,5,2,5145,3,45;1,5,2,5145,3,75;1,5,2,5145,3,105;1,5,2,5175,3,105;1,5,2,5175,3,75;1,2,2,5115,3,135;1,2,2,5145,3,135;1,2,2,5175,3,135;1,5,2,5295,3,15;1,5,2,5265,3,15;1,5,2,5235,3,15;1,5,2,5205,3,15;1,5,2,5295,3,45;1,5,2,5265,3,45;1,5,2,5235,3,45;1,5,2,5205,3,45;1,5,2,5205,3,105;1,5,2,5235,3,105;1,5,2,5265,3,105;1,5,2,5295,3,105;1,5,2,5295,3,75;1,5,2,5265,3,75;1,5,2,5235,3,75;1,5,2,5205,3,75;1,2,2,5205,3,135;1,2,2,5235,3,135;";
	char* iter = (char*)lv_str;
	bool still_should_read = true;
	int audio_id = 0;
	while (still_should_read) {
		char* id_str = iter;
		while (*iter != ',' && *iter)
			iter++;
		if (!(*iter))
			break;
		*iter = '\0';
		iter++;
		char* val_str = iter;
		while (*iter != ',' && *iter != ';' && *iter)
			iter++;
		if (!(*iter))
			break;
		still_should_read = *iter == ',';
		*iter = '\0';
		iter++;
		if (id_str[0] == 'k') {
			if (id_str[1] == 'S') {
				switch (id_str[2]) {
				case '1': {
					this->def_bg_col.r = (float)ATOI(val_str);
					break;
				}
				case '2': {
					this->def_bg_col.g = (float)ATOI(val_str);
					break;
				}
				case '3': {
					this->def_bg_col.b = (float)ATOI(val_str);
					break;
				}
				case '4': {
					break;
					this->def_gr_col.r = (float)ATOI(val_str);
				}
				case '5': {
					this->def_gr_col.g = (float)ATOI(val_str);
					break;
				}
				case '6': {
					this->def_gr_col.b = (float)ATOI(val_str);
					break;
				}
				default: {
					SINFO("UNKNOWN HEAD %s:%s", id_str, val_str);
					break;
				}
				}
			}
			else if (id_str[1] == 'A') {
				if (id_str[2] == '1')
					audio_id = ATOI(val_str);
			}
		}
	}
	size_t obj_count = 0;
	while (*iter) {
		still_should_read = true;
		GObject* obj = NULL;
		while (still_should_read) {
			char* id_str = iter;
			while (*iter != ',' && *iter)
				iter++;
			if (!(*iter))
				break;
			*iter = '\0';
			iter++;
			char* val_str = iter;
			while (*iter != ',' && *iter != ';' && *iter)
				iter++;
			if (!(*iter))
				break;
			still_should_read = *iter == ',';
			*iter = '\0';
			iter++;
			if (*id_str && !id_str[1]) {
				switch (id_str[0]) {
				case '1': {
					switch (ATOI(val_str)) {
					case 1: {
						obj = f_alloc(sizeof(GBlock));
						gblock_init((GBlock*)obj);
						break;
					}
					}
					break;
				}
				case '2': {
					if (obj)
						obj->pos.x = ATOF(val_str);
					break;
				}
				case '3': {
					if (obj)
						obj->pos.y = 500.0f - ATOF(val_str);
					break;
				}
				}
			}
		}
		if (obj != NULL)
			this->obj[obj_count++] = obj;
	}
}

void scene_game_on_run(SceneGame* this) {
	app->clock_reset();
}

void scene_game_on_update(SceneGame* this) {
	
}

void scene_game_on_draw(SceneGame* this) {
	ren->fill_rect_s(&RECT(100, 100, 30, 30), &this->def_bg_col);
	ren->fill_rect_s(&RECT(100, 200, 30, 30), &this->def_gr_col);
	for (size_t i = 0; i < 1024 * 4; i++) {
		if (this->obj[i] != NULL) {
			this->obj[i]->on_draw(this->obj[i]);
		}
	}
}

void scene_game_on_stop(SceneGame* this) {

}

void scene_game_on_destroy(SceneGame* this) {
	for (size_t i = 0; i < 1024 * 4; i++) {
		if (this->obj[i] != NULL) {
			f_free(this->obj[i]);
		}
	}
	f_free(this->obj);
}

Scene* scene_game_create(void) {
	SceneGame* this = f_alloc(sizeof(SceneGame));
	scene_fill_defaults(base);
	FCAST(base->on_init, scene_game_on_init);
	FCAST(base->on_run, scene_game_on_run);
	FCAST(base->on_update, scene_game_on_update);
	FCAST(base->on_draw, scene_game_on_draw);
	FCAST(base->on_stop, scene_game_on_stop);
	FCAST(base->on_destroy, scene_game_on_destroy);
	return base;
}
